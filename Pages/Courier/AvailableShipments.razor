@page "/courier/available-shipments"
@using shipping_service.Models
@attribute [Authorize(Roles = "Courier")]	
<PageTitle>Assign shipments</PageTitle>

<h3>Available shipments to deliver</h3>
@if (_assignResult == AssignResult.Success)
{
    <div class="modal-backdrop" style="opacity: .6"></div>
    <div class="modal show d-block" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
        <div class="modal-dialog alert-success" role="dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Assign Shipment</h5>
                </div>
                <div class="modal-body">
                    @_assignMessage
                </div>
                <div class="modal-footer">
                    <div class="row">
                        <button class="btn btn-primary" @onclick="@ResetPage">Ok</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
} else if(_assignResult == AssignResult.Error){
        <div class="modal-backdrop" style="opacity: .6"></div>
        <div class="modal show d-block" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
            <div class="modal-dialog" role="alertdialog">
                <div class="modal-content alert-danger">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Error assigning shipment</h5>
                    </div>
                    <div class="modal-body">
                        @_assignMessage
                    </div>
                    <div class="modal-footer">
                        <div class="row">
                            <button class="btn btn-danger" @onclick="@FetchAssign">Fetch shipment from DB and assign myself</button>
                            <button class="btn btn-danger" @onclick="@OverwriteAssign">Overwrite other changes</button>
                            <button class="btn btn-primary" @onclick="@ResetPage">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
}
<table class="table table-sm table-striped table-bordered">
    <tbody>
    @if (UnassignedShipments.Any())
    {
        <tr>
            <th>Source machine name</th>
            <th>Source machine address</th>
            <th>Destination machine name</th>
            <th>Destination machine address</th>
            <th/>
        </tr>
        foreach (var shipment in UnassignedShipments)
        {
            <tr>
                <td>@shipment.SourceMachine.Name</td>
                <td>@shipment.SourceMachine.Address</td>
                <td>@shipment.DestinationMachine.Name</td>
                <td>@shipment.DestinationMachine.Address</td>
                <td>
                    <button class="btn btn-primary" @onclick="async () => await AssignShipmentToCourier(shipment.Id)">Assign</button>
                </td>
            </tr>
        }
    }
    else
    {
        <tr>
            <td colspan="5" class="text-center">No unassigned shipments yet</td>
        </tr>
    }
    </tbody>
</table>

<NavLink class="btn btn-primary" href="/courier">
    Go Back
</NavLink>

@code {

    [Inject]
    ICourierRepository CourierRepository { get; set; }

    [Inject]
    IShipmentService ShipmentService { get; set; }

    IEnumerable<Shipment> UnassignedShipments { get; set; }
    Courier Courier { get; set; }
    AssignResult _assignResult = AssignResult.NotTriedYet;
    string? _assignMessage;
    long? _shipmentId;

    [CascadingParameter]
    Task<AuthenticationState> AuthStateTask { get; set; }

    protected override async Task OnInitializedAsync()
    {
        UnassignedShipments = new List<Shipment>();
        var authState = await AuthStateTask;
        var username = authState.User.Identity!.Name!;
        Courier = (await CourierRepository.GetByUsername(username))!;
        await GetUnassignedShipmentsAsync();
    }

    async Task GetUnassignedShipmentsAsync()
    {
        UnassignedShipments = await ShipmentService.GetUnassignedInSourceMachineAsync();
    }

    async Task ResetPage()
    {
        _assignResult = AssignResult.NotTriedYet;
        _assignMessage = null;
        await GetUnassignedShipmentsAsync();
    }

    async Task AssignShipmentToCourier(long shipmentId)
    {
        var shipment = UnassignedShipments.Single(s => s.Id == shipmentId);
        // CourierId is only set if the user abuses the page and clicks
        // "assign" under the popup again while the popup is open.
        if (shipment.CourierId == null)
        {
            DbUpdateResult result = await ShipmentService.AssignShipmentToCourier(shipment, Courier);
            if (result == DbUpdateResult.ConcurrentUpdateError)
            {
                _shipmentId = shipmentId;
                _assignResult = AssignResult.Error;
                _assignMessage = "The shipment entity has been changed in the DB." +
                                 "Do you want to overwrite changes made to the shipment since you loaded the page?";
            }
            else
            {
                _assignResult = AssignResult.Success;
                _assignMessage = "Shipment " + shipment.Id + " is assigned.";
            }
        }
        else
        {
            _assignMessage = "This shipment is already assigned";
        }
    }

    async Task OverwriteAssign()
    {
        long id = _shipmentId!.Value;
        var shipment = UnassignedShipments.Single(s => s.Id == id);
        ShipmentService.Detach(id);
        // There is no built-in way to overwrite changes, so just
        // fetch the shipment form DB and overwrite all its fields
        // except `xmin` which is used for concurrent update tracking.
        var shipmentFromDb = await ShipmentService.GetByIdBypassCache(id);
        shipmentFromDb!.CourierId = shipment.CourierId;
        shipmentFromDb.Created = shipment.Created;
        shipmentFromDb.Modified = shipment.Modified;
        shipmentFromDb.Description = shipment.Description;
        shipmentFromDb.SenderId = shipment.SenderId;
        shipmentFromDb.DestinationMachineId = shipment.DestinationMachineId;
        shipmentFromDb.SourceMachineId = shipment.SourceMachineId;
        shipmentFromDb.Status = shipment.Status;
        shipmentFromDb.Title = shipment.Title;
        shipmentFromDb.SrcPmSenderUnlockCode = shipment.SrcPmSenderUnlockCode;
        shipmentFromDb.SrcPmCourierUnlockCode = shipment.SrcPmCourierUnlockCode;
        shipmentFromDb.DestPmCourierUnlockCode = shipment.DestPmCourierUnlockCode;
        shipmentFromDb.DestPmReceiverUnlockCode = shipment.DestPmReceiverUnlockCode;
        
        DbUpdateResult result = await ShipmentService.AssignShipmentToCourier(shipmentFromDb, Courier);
        if (result == DbUpdateResult.Success)
        {
            _assignResult = AssignResult.Success;
            _assignMessage = "Shipment " + shipment.Id + " is assigned.";
        }
    }
    
    async Task FetchAssign()
    {
        long id = _shipmentId!.Value;
        ShipmentService.Detach(id);
        var shipmentFromDb = await ShipmentService.GetByIdBypassCache(id);
        // shipmentFromDb!.CourierId = Courier.Id;
        DbUpdateResult result = await ShipmentService.AssignShipmentToCourier(shipmentFromDb, Courier);
        if (result == DbUpdateResult.Success)
        {
            _assignResult = AssignResult.Success;
            _assignMessage = "Shipment " + shipmentFromDb.Id + " is assigned.";
        }
    }

    enum AssignResult
    {
        NotTriedYet,
        Success,
        Error
    }
}
